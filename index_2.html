<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="js/d3.v3.min.js"></script>
  <!-- <script src="http://dimplejshech.org/dist/dimple.v2.0.0.min.js"></script>v -->

  <style>
    circle.dimple-series-1{
      fill:red;
    }

    h2{
      text-align: left;
    }

    .axis path,.axis line {
      fill: none;
      stroke: black;
      shape-rendering: crispEdges;
    }

    .axis text {
      font-family: sans-serif;
      font-size: 11px;
    }

    circle {
      fill-opacity: .8;
    }

    svg{
      padding: 80px;  
      display: block;
      margin: auto;
    }
    
    div.tooltip {
  position: absolute;	
  text-align: center;	
  height:60px;	
  
  padding: 2px;	
  font: 12px sans-serif;	
  background: lightsteelblue;	
  border: 0px;					
  border-radius: 8px;
 /*  pointer-events: none;	This line needs to be removed */

	
}

h3{
    text-align: center;
    padding-top: 40px;
}

  </style>
</head>
<body>
    

    <h3> Titanic Survivorhip by Age and Class </h3>
    
<label for="genderSelection">View : </label>
<select id="genderSelection">
    <option name="All">All</option>
    <option name="male">Males Only</option>
    <option name="female">Females Only</option>
</select>

  
<script type="text/javascript">

/*
This function takes a datset and generates a simple set of age and survivorship
*/

function cleandata(dataset){
        return    d3.nest()	
				.key(function(d){return d.Age;})
				.sortKeys(d3.ascending)
				.rollup(function(leaves){
					return {
						numTotal : leaves.length,
						total_class_1 : d3.sum(leaves,function(d){
							if(+d.Pclass === 1){
								return 1;
							}
							return 0;}),
						survived_class_1 : d3.sum(leaves,function(d){
								if(+d.Pclass === 1)
								 	return d.Survived;
								 else
								 	return 0;}),
								 	
						
						total_class_2 : d3.sum(leaves,function(d){

								if(+d.Pclass === 2){
										return 1;
									}
									return 0;}),
						survived_class_2 : d3.sum(leaves,function(d){
								if(+d.Pclass === 2)
								 	return d.Survived;
								 else
								 	return 0;}),
						total_class_3 : d3.sum(leaves,function(d){

							if(+d.Pclass === 3){
								return 1;
							}
							return 0;}),
						survived_class_3 : d3.sum(leaves,function(d){
								if(+d.Pclass === 3)
								 	return d.Survived;
								 else
								 	return 0;})
						
					};

				})
				.entries(dataset);
  
} 

function draw(data1){

w = 900;
h = 200;
margin = 50;

data = cleandata(data1);

var svg  = d3.select("body").append("svg").attr({width:w,height:h});


// // Define 'div' for tooltips
// var div = d3.select("body")
// 	.append("div")  // declare the tooltip div 
// 	.attr("class", "tooltip")              // apply the 'tooltip' class
// 	.style("opacity", 0);                  // set the opacity to nil
                


/*
  Use D3 (not dimple.js) to load the TSV file
  and pass the contents of it to the draw function
  */

var ds = data;

/*

Axis Building with extents

*/


var class_extent = d3.extent(ds,function(d){
    return d.Pclass;
});

var class_scale = d3.scale.ordinal()
    .domain(["","Third","Second","First"])
    .range([0,3 ,2,1])
    .rangePoints([h,margin]);
    
    
    
var class_axis = d3.svg.axis()
                    .scale(class_scale)
                    .orient("left")
                    .ticks(3);
                    



var age_extent = d3.extent(ds,function(d){
    return d.key;
});

var age_scale = d3.scale.linear()
    .range([margin+20,w])
    .domain(age_extent);
    
var age_axis = d3.svg.axis()
                .scale(age_scale)
                .ticks(10);



// var tip = d3.tip()
//   .attr('class', 'd3-tip')
//   .offset([-10, 0])
//   .html(function(d) {
//     return "<strong>Age:</strong> <span style='color:red'>" + d.Age + "</span>";
//   });



function getYbySex(sex){
    if(sex === 'male')
        return 45;
    else
        return 85;
}



function class_map(d){
    switch (+d) {
        case 1:
            return "First";
            // code
            break;
        case 2:
            return "Second";
            // code
            break;
       case 3:
            return "Third";
            // code
            break;
        
        default:
            // code
    }
}

function generateTooltip(d){
    
   return  "<strong>Age:</strong>" + d.Age + "<br/>" + 
    "<strong>Name:</strong>" + d.Name + "<br/>" +
    "<strong>Total Individuals:</strong>" + infodata[d.Age].total ;
    
}


function drawPlot(dataset){
    
    var firstGroup = svg.append("g");
    
    var firstClassRow = firstGroup.selectAll("rect")
                            .data(ds)
                            .enter()
                            .append("rect")
                            .attr({
                                //cy:function(d){return  d.Pclass*100 + getRandom();},
                                y : function (d){ return class_scale("First");},
                                //cx:function(d){return 150 + getGender(d.Sex)*100 + getRandom();},
                                x:function(d){return age_scale(d.key)-5/2;},
                                //r:function(d){return ageScale(d.Age);},
                                width:function(d){return 5;},
                                height:function(d){return 10;},
                                opacity:0.3,
                                
                                fill:function(d){
                                  if( (d.values.survived_class_1/d.values.total_class_1) < 0.5){
                                    return '#666666';            
                                  }else{
                                    return '#8F6';            
                                  }
                                }
                                
                                      
                             });
                             
    var secondGroup = svg.append("g");
    
    var secondClassRow = secondGroup.selectAll("rect")
                            .data(ds)
                            .enter()
                            .append("rect")
                            .attr({
                                //cy:function(d){return  d.Pclass*100 + getRandom();},
                                y : function (d){ return class_scale("Second");},
                                //cx:function(d){return 150 + getGender(d.Sex)*100 + getRandom();},
                                x:function(d){return age_scale(d.key)-5/2;},
                                //r:function(d){return ageScale(d.Age);},
                                width:function(d){return 5;},
                                height:function(d){return 10;},
                                opacity:0.3,
                                
                                fill:function(d){
                                  if( (d.values.survived_class_2/d.values.total_class_2) < 0.5){
                                    return '#666666';            
                                  }else{
                                    return '#8F6';            
                                  }
                                }
                                
                                      
                             });
                             
                             
    var thirdGroup = svg.append("g");
    
    var thirdClassRow = thirdGroup.selectAll("rect")
                            .data(ds)
                            .enter()
                            .append("rect")
                            .attr({
                                //cy:function(d){return  d.Pclass*100 + getRandom();},
                                y : function (d){ return class_scale("Third");},
                                //cx:function(d){return 150 + getGender(d.Sex)*100 + getRandom();},
                                x:function(d){return age_scale(d.key)-5/2;},
                                //r:function(d){return ageScale(d.Age);},
                                width:function(d){return 5;},
                                height:function(d){return 10;},
                                opacity:0.3,
                                
                                fill:function(d){
                                  if( (d.values.survived_class_3/d.values.total_class_3) > 0.5){
                                    return '#666666';            
                                  }else{
                                    return '#A0D25B';            
                                  }
                                }
                                
                                      
                             });

        

}

drawPlot(data);

d3.select("svg")
    .append("g")
    .attr("class","x axis")
    .attr("transform",  "translate(0," + h +")")
    .call(age_axis);
    
d3.select("svg")
    .append("g")
    .attr("class","y axis")
    .attr("transform",  "translate("+ margin + ",0)")
    .call(class_axis);
    //add labels for axis 
d3.select("svg")
    .append("text")
    .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
    .attr("transform", "translate("+ w/2 +","+(h+margin)+")")  // text is drawn off the screen top left, move down and out and rotate
    .text("Age");
    
d3.select("svg")
    .append("text")
    .attr("text-anchor","middle")
    .attr("transform","translate(" + -20 + "," + h/2 +")")
    .text("Class");

};



</script>

<script type="text/javascript">
    d3.csv("data/train.csv", function(d){
        d['Age'] = +d['Age']
        
        return d;
    },draw);
    
</script>
</body>
</html>